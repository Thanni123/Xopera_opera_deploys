---
- name: Configure Azure
  hosts: localhost
  vars:
    resource_group: thumbnailgeneration-rg
    location: westeurope
    resource_group_name: newresourcegroupforthanh
    storage_account_name: storageaccforthanh
    current_directory: "{{ lookup('env', 'PWD') }}"
    function_app_name: myimageresizerappv01
    zip_file: X-test-ImageRes.zip
  tasks:
#NOTE: Azure Platform
    - name: install azure-cli
      pip:
        name: azure-cli
        state: present

    - name: Create a resource group
      command: >
         az group create
         -l "{{ location }}"
         -n "{{ resource_group }}"

    - name: Create storage account
      command: >
         az storage account create
         --name "{{ storage_account_name }}"
         --resource-group "{{ resource_group }}"

#NOTE: Azure Function
    - name: Find .zip file by name
      find:
        paths: "{{ current_directory }}"
        patterns: "{{ zip_file }}"
        recurse: yes
      register: zip_file_matched_subdirectory

    - name: Matched zip file
      debug:
        msg: "Matched zip file: {{ zip_file_matched_subdirectory.files[0].path }}"

    - name: Create a Azure Function
      command: >
         az functionapp create
         -g "{{ resource_group }}"
         -p serverlessPlan
         -n "{{ function_app_name }}"
         -s "{{ storage_account_name }}"

    - name: Deploy code to Azure function
      command: >
         az functionapp deployment source config-zip
         -g "{{ resource_group }}"
         -n "{{ function_app_name }}"
         --src "{{ zip_file_matched_subdirectory }}"
